<project xmlns:if="ant:if" xmlns:unless="ant:unless" 
   name="dhq"
   default="previewArticle">
  
<!--
    Apache Ant buildfile for Digital Humanities Quarterly.
  -->
  
<!-- 
    See build-properties.xml for the settings used in this file. When referenced, 
    properties look like this:
      ${toDir}
    For more information, see https://ant.apache.org/manual/Tasks/xmlproperty.html
  -->
  <xmlproperty file="build-properties.xml" keepRoot="false"/>
  
  
<!-- 
    ANT TASKS
  -->
  
  <!-- Generate static HTML versions of the DHQ articles. -->
  <target name="generateArticles">
    <mkdir dir="${toDir}${file.separator}${context}${file.separator}vol"/>
    <!-- Use XSLT to transform articles using the DHQ table of contents. -->
    <xslt in="toc${file.separator}toc.xml" 
          out="${toDir}${file.separator}article-map.xml"
          style="common${file.separator}xslt${file.separator}generate_static_articles.xsl"
          classpath="${processor.location}"
          force="true"
          failonerror="false">
      <factory name="${processor.name}"/>
      <param name="context" expression="${context}"/>
      <param name="dir-separator" expression="${file.separator}"/>
      <!--<param name="repo-dir" expression="${basedir}"/>-->
      <param name="static-dir" expression="${toDir}${file.separator}${context}"/>
    </xslt>
  </target>
  
  <!-- Generate a static version of the DHQ website. -->
  <target name="generateSite" depends="generateArticles">
    <mkdir dir="${toDir}${file.separator}${context}"/>
    <!-- TODO -->
    <antcall target="compressStatic"/>
  </target>
  
  <!-- Compress the static site's files for backup and transportation. -->
  <target name="compressStatic">
    <zip destfile="${toDir}${file.separator}${context}.zip">
      <fileset dir="${toDir}${file.separator}${context}"/>
    </zip>
  </target>
  
  <!-- Create an HTML preview version of a single article. -->
  <target name="previewArticle">
    <!-- If the 'article.id' property wasn't already set using the command line, Ant 
      will prompt for it. -->
    <input unless:set="article.id" 
      message="Please give the ID of the article you want to view:" 
      addproperty="article.id"/>
    <!-- Test the 'article.id' property to make sure it has 6 digits and doesn't 
      start with '9'. -->
    <condition property="article.id.ok" value="${article.id}">
      <matches string="${article.id}" pattern="^[0-8]\d{5,5}$"/>
    </condition>
    <fail unless="article.id.ok"
       message="An article ID must be 6 digits long. It must not start with '9'"/>
    <!-- If it doesn't exist yet, create the preview directory specified in 
      build-properties.xml. -->
    <mkdir dir="${previewDir}"/>
    <!-- Transform the article with XSLT. -->
    <xslt in="articles${file.separator}${article.id}${file.separator}${article.id}.xml" 
          out="${previewDir}${file.separator}${article.id}.html"
          style="common${file.separator}xslt${file.separator}template_article.xsl"
          classpath="${processor.location}"
          force="true"
          failOnTransformationError="false">
      <factory name="${processor.name}"/>
      <param name="context" expression="dhq"/>
      <param name="dir-separator" expression="${file.separator}"/>
      <param name="assets-path" expression="..${file.separator}"/>
    </xslt>
    <echo message="Created article preview at ${previewDir}${file.separator}${article.id}.html"/>
  </target>
  
</project>
