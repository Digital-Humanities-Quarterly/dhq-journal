<?xml version="1.0"?>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<!-- testing… 1, 2, 3… testing… -->
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
    <map:components>
        <map:actions>
            <map:action name="http" src="org.apache.cocoon.acting.HttpCacheAction"/>
            <map:action name="req-params" src="org.apache.cocoon.acting.RequestParameterExistsAction"/>
        </map:actions>
    
    <!-- =========================== For XSLT2 =============================== -->

        <map:transformers default="xslt">
   	 		<map:transformer name="xslt2" pool-grow="2" pool-max="32" pool-min="8"
       			 src="org.apache.cocoon.transformation.TraxTransformer">
      		<use-request-parameters>false</use-request-parameters>
      		<use-browser-capabilities-db>false</use-browser-capabilities-db>
      		<xslt-processor-role>saxon</xslt-processor-role>
    	</map:transformer>
  </map:transformers>
    </map:components>
    
    
    
    <!-- =========================== Views =================================== -->
    <map:views>
        <map:view name="content" from-label="content">
            <map:serialize type="xml"/>
        </map:view>
          <map:view from-label="content" name="pretty-content">
            <map:transform type="xslt2" src="context://stylesheets/system/story2HTML.xslt"/>
            <map:serialize type="html"/>
          </map:view>
          <map:view name="links" from-position="last">
            <map:serialize type="links"/>
          </map:view>
    </map:views>
    
    <map:flow language="javascript">
        <map:script src="flow.js"/>
    </map:flow>

    <!-- =========================== Pipelines ================================= -->
    <map:pipelines>
        <map:component-configurations>
            <!-- Set context of DHQ files for either /dhq/ or /dhqdev here.
            -->
            <global-variables>
                <context>dhq</context>
            </global-variables>
            <authentication-manager>
                <handlers>
                    <!-- A handler is responsible for protecting documents (pipelines).
                        The handler requires three configuration values. One of them is
                        a unique name that is used as a reference for the handler.
                        The other values are documented inline below. 
                    -->
                    <handler name="authhandler">
                        <!-- The redirect-to configuration defines a pipeline that is called
                            whenever a not authenticated user tries to access a protected
                            document (pipeline) -->
                        <redirect-to uri="login.html"/>
                        <!-- The authentication configuration defines the authentication process.
                            In this example, an internal pipeline "authenticate" is called.
                            This pipeline gets all necessary information like user name and
                            password as parameters and tries to authenticate this user.
                            On successful authentication the pipeline delivers a specific
                            XML format.
                        --> 	 
                        <authentication uri="cocoon:raw:/authenticate"/>
                        <!-- In addition you can specifiy a logout-uri parameter above. Then
                            the pipeline denoted by that parameter is called on logout.
                        -->
                    </handler>
                </handlers>
            </authentication-manager>
        </map:component-configurations>
        
        <map:pipeline>
        <!-- jawalsh: for testing saxon and xslt 2.0 -->
       <map:match pattern="starter.html">
                <map:generate src="common/tests/starter.xml"/>
                <map:transform type="xslt2" src="common/tests/test2.xsl">
                <map:parameter name="fpath" value="starter.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
       </map:match>
       
            <!-- pattern to access articles with custom XSLT -->
            <!-- 000151 -->
            <!-- Need pipeline for both regular and editorial -->
            
            <!-- jawalsh: instead of separate "regular" and editorial stylesheets, we should have one stylesheet
                that does regular or editorial stuff as needed. -->
          
            <!-- test. -->
            
            <!-- custom editorial pipelines: start --> 
            
            <!-- Editorial Login page -->
            <map:match pattern="editorial/login.html">
                <!-- if we are already logged in, redirect to the protected document -->
                <map:act type="auth-loggedIn">
                    <map:parameter name="handler" value="authhandler"/> 
                    <map:redirect-to uri="editorial/index.html"/>
                </map:act> 
                <map:generate src="editorial/login.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="login.html"/>
                </map:transform>
                <map:transform type="encodeURL"/>
                <map:serialize type="xhtml"/>
            </map:match>
            
            <map:match type="regexp" pattern="editorial/(\d+/)(999999)\.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="articles/{../2}/{../2}.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="articles/{../2}/resources/xslt/{../2}.xsl">
                        <map:parameter name="fpath" value="editorial/{../2}/{../2}.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            
             <map:match type="regexp" pattern="editorial/(\d+/)(000212|000151|000501)\.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="articles/{../2}/{../2}.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="articles/{../2}/resources/xslt/{../2}.xsl">
                        <map:parameter name="fpath" value="editorial/{../2}/{../2}.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>

   	    

            <!-- custom editorial pipelines: end --> 
            
            
            <!-- custom article pipelines: start -->
            
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(000150)\.html">
                <map:generate src="articles/{4}/{4}.xml"/>
                <map:transform type="xslt2" src="articles/000150/resources/xslt/{4}.xsl">
                    <map:parameter name="fpath" value="vol/{1}/{2}/{3}{4}.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                    <map:parameter name="id" value="{4}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(000151|000212|000214|000218|000501)\.html">
                <map:generate src="articles/{4}/{4}.xml"/>
                <map:transform type="xslt2" src="articles/{4}/resources/xslt/{4}.xsl">
                    <map:parameter name="fpath" value="vol/{1}/{2}/{3}{4}.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                    <map:parameter name="id" value="{4}"/>
                </map:transform>
                <map:serialize type="xhtml"/> 
            </map:match>
            
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(999999)\.html">
                <map:generate src="articles/{4}/{4}.xml"/>
                <map:transform type="xslt2" src="articles/{4}/resources/xslt/{4}.xsl">
                    <map:parameter name="fpath" value="vol/{1}/{2}/{3}{4}.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                    <map:parameter name="id" value="{4}"/>
                </map:transform>
                <map:serialize type="xhtml"/> 
            </map:match>
            
            <!-- custom article pipelines: end -->
            
               <!-- pattern to access archives for revised articles -->
            <!--<map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+)/(\d+_\d\d)\.html">-->
            <map:match pattern="vol/6/2/000128/000128_01.html">
           <!--<map:read src="articles/000128/000128_01.xml" mime-type="text/xml"/>-->
           
               <!-- <map:generate src="articles/{3}/{4}.xml"/> +here+ -->
           
               <map:generate src="articles/000128/000128_01.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="fpath" value="vol/6/2/000128/000128_01.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="vol" value="6"/>
                    <map:parameter name="issue" value="2"/>
                    <map:parameter name="id" value="000128_01"/>
                    <map:parameter name="use-request-parameters" value="true"/>
                </map:transform>
                <map:serialize type="xhtml"/>
           
            </map:match>
            
             <map:match pattern="vol/6/2/000128/000009_01.html">
           <!--<map:read src="articles/000128/000128_01.xml" mime-type="text/xml"/>-->
           
               <!-- <map:generate src="articles/{3}/{4}.xml"/> +here+ -->
           
               <map:generate src="articles/000009/000009_01.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="fpath" value="vol/6/2/000128/000128_01.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="vol" value="1"/>
                    <map:parameter name="issue" value="2"/>
                    <map:parameter name="id" value="000009_01"/>
                    <map:parameter name="use-request-parameters" value="true"/>
                </map:transform>
                <map:serialize type="xhtml"/>
           
            </map:match>
            
            <!-- attempt at general pipeline for all revised articles -->
             <!--<map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+)/(\d+_\d\d)\.html">-->
            <map:match pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(\d+_\d\d)\.html">
           <!--<map:read src="articles/000128/000128_01.xml" mime-type="text/xml"/>-->
           
               <!-- <map:generate src="articles/{3}/{4}.xml"/> +here+ -->
           
               <map:generate src="articles/{3}{4}.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="vol/{1}/{2}/{3}{4}.html"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                    <map:parameter name="id" value="{4}"/>
                    <map:parameter name="use-request-parameters" value="true"/>
                </map:transform>
                <map:serialize type="xhtml"/>
           
            </map:match>
            
            
            <map:act type="http"/>
            
            <!-- galleria -->
            
            <map:match pattern="common/galleria/**.css">
                <map:read mime-type="text/css" src="common/galleria/{1}.css"/>
            </map:match>
            
            <map:match pattern="common/galleria/**.js">
                <map:read mime-type="text/javascript" src="common/galleria/{1}.js"/>
            </map:match>
            
            <map:match pattern="common/galleria/**.png">
                <map:read mime-type="image/png" src="common/galleria/{1}.png"/>
            </map:match>
            
            <map:match pattern="common/galleria/**.gif">
                <map:read mime-type="image/gif" src="common/galleria/{1}.gif"/>
            </map:match>
            
            <!-- css -->
            <map:match pattern="common/css/*.css">
                <map:read mime-type="text/css" src="common/css/{1}.css"/>
            </map:match>
            <map:match pattern="common/js/*.js">
                <map:read mime-type="text/javascript" src="common/js/{1}.js"/>
            </map:match>
            <!-- for xsl stylesheet to display XML content -->
            <map:match type="regexp" pattern="/Schemas/(.+)\.xsl">
                <map:read mime-type="text/xsl" src="common/schema/{1}.xsl"/>
            </map:match>
            <!-- pattern match for DHQauthor.rng schema -->
            <map:match pattern="common/schema/*">
                 <map:read src="common/schema/{1}"/>
            </map:match>
            <!-- pattern match for article templats -->
            <map:match pattern="articles/templates/*">
                 <map:read src="articles/templates/{1}"/>
            </map:match>
            <!-- About DHQ Page  -->
            <map:match pattern="about/about.html">
                <map:generate src="about/about.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="about/about.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- About Ethics Page -->
            <map:match pattern="about/ethics_code.html">                                                                          
                <map:generate src="about/ethics_code.html"/>                                                                      
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">                                          
                    <map:parameter name="context" value="{global:context}"/>                                                      
                    <map:parameter name="fpath" value="about/ethics_code.html"/>                                                  
                </map:transform>                                                                                                  
                <map:serialize type="xhtml"/>                                                                                     
            </map:match>    
            <!-- About Search Page  -->
            <map:match pattern="about/search.html">
                <map:generate src="about/search.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="about/search.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- aprilfool -->
            <map:match pattern="about/april1_editorial_policy.html">
                <map:generate src="about/april1_editorial_policy.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="fpath" value="about/april1_editorial_policy.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- Contact page -->
            <map:match pattern="contact/contact.html">
                <map:generate src="contact/contact.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="contact/contact.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- DHQ People -->
            <map:match pattern="people/people.html">
                <map:generate src="people/people.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="people/people.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- Submission guidelines -->
            <map:match pattern="submissions/index.html">
                <map:generate src="submissions/index.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/index.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="submissions/textGuidelines.html">
                <map:generate src="submissions/textGuidelines.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/textGuidelines.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="submissions/mediaGuidelines.html">
                <map:generate src="submissions/mediaGuidelines.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/mediaGuidelines.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="submissions/specialIssuesGuidelines.html">
                <map:generate src="submissions/specialIssuesGuidelines.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/specialIssuesGuidelines.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="submissions/peerReviewing.html">
                <map:generate src="submissions/peerReviewing.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/peerReviewing.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="submissions/*.html">
                <map:generate src="submissions/{1}.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="submissions/{1}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- Submissions guidelines: dhq_author_template.xml -->
            <map:match pattern="submissions/dhq_author_template.xml">
                <map:read src="articles/templates/dhq_author_template.xml" mime-type="text/xml"/>
            </map:match>
            <!-- Announcements -->
            <map:match type="regexp" pattern="announcements/?(index.html)?">
                <map:generate src="announcements/index.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                <map:parameter name="fpath" value="announcements/index.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <map:match pattern="authenticate">
                <map:generate src="editorial/userlist.xml"/>
                <map:transform type="xslt2" src="common/xslt/authenticate.xsl">
                    <map:parameter name="use-request-parameters" value="true"/>
                </map:transform>
                <map:serialize type="xml"/>
            </map:match>
            
            <!-- Search -->
            <map:match pattern="findIt">
                <map:generate type="search" label="content"/>
                <map:transform type="log"/>
                <map:transform type="xslt2" src="common/xslt/search_results.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            
            <!-- Login action -->
            <map:match pattern="do-login">
                <map:act type="auth-login">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:parameter name="parameter_name" value="{request-param:user}"/>
                    <map:parameter name="parameter_password" value="{request-param:pass}"/>
                    <map:redirect-to uri="editorial/index.html"/>
                </map:act>
                <map:redirect-to uri="editorial/login_failure.html"/>
            </map:match>
            <!-- Logout action -->
            <map:match pattern="do-logout">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:act type="auth-logout"/>
                </map:act>
                <map:redirect-to uri="editorial/login.html"/>
            </map:match>
            <!-- redirects for older style URL requests [CRB] -->
            <map:match type="regexp" pattern="editorial/(\d+)\.html">
                <map:redirect-to uri="{1}/{1}.html"/>
            </map:match>
            <!-- pattern to access editorial articles -->
            <map:match type="regexp" pattern="editorial/(\d+/)(\d+)\.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="articles/{../2}/{../2}.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/template_editorial_article.xsl">
                        <map:parameter name="fpath" value="editorial/{../2}/{../2}.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- redirects for older style URL requests [CRB] -->
            <map:match type="regexp" pattern="editorial/(\d+)\.xml">
                <map:redirect-to uri="editorial/{1}/{1}.xml"/>
            </map:match>
            <!-- pattern to access editorial xml source -->
            <map:match type="regexp" pattern="editorial/(\d+/)(\d+)\.xml">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:read src="articles/{../2}/{../2}.xml" mime-type="text/xml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern to match author bios for editorial articles -->
            <map:match pattern="editorial/bios.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/template_editorial_bios.xsl">
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="fpath" value="editorial/bios.html"/>
                    </map:transform>
                    <map:transform type="xslt2" src="common/xslt/bios_sort.xsl"/>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort default by article id, ascending) -->
            <map:match pattern="editorial/articles.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort by article id, descending) -->
            <map:match pattern="editorial/articles_desc.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles_desc.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="direction" value="desc"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort by issue, ascending) -->
            <map:match pattern="editorial/articles_issue.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles_issue.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="sort" value="issue"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort by issue, descending) -->
            <map:match pattern="editorial/articles_issue_desc.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles_issue_desc.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="sort" value="issue"/>
                        <map:parameter name="direction" value="desc"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort by title, ascending) -->
            <map:match pattern="editorial/articles_title.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles_title.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="sort" value="title"/>
                    </map:transform>
                    <map:transform type="xslt2" src="common/xslt/search_results_title_sort.xsl"/>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern for article list (sort by title, descending) -->
            <map:match pattern="editorial/articles_title_desc.html">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/article_list.xsl">
                        <map:parameter name="fpath" value="editorial/articles_title_desc.html"/>
                        <map:parameter name="sort" value="title"/>
                        <map:parameter name="direction" value="desc"/>
                    </map:transform>
                    <map:transform type="xslt2" src="common/xslt/search_results_title_sort_desc.xsl"/>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern to match search index creation function -->
            <map:match pattern="editorial/create">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:call function="create">
                        <map:parameter name="context" value="{global:context}"/>
                    </map:call>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern to match search index creation -->
            <map:match pattern="editorial/create-index.jx">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate type="jx" src="editorial/create-index.jx"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                        <map:parameter name="context" value="{global:context}"/>
                        <map:parameter name="fpath" value="login_failure.html"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            <!-- pattern to access editorial toc -->
            <map:match type="regexp" pattern="editorial/?(index\.html)?$">
                <map:act type="auth-protect">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:generate src="toc/toc.xml"/>
                    <map:transform type="session"/>
                    <map:transform type="xslt2" src="common/xslt/template_editorial.xsl">
                        <map:parameter name="fpath" value="editorial/index.html"/>
                        <map:parameter name="context" value="{global:context}"/>
                    </map:transform>
                    <map:transform type="encodeURL"/>
                    <map:serialize type="xhtml"/>
                </map:act>
                <map:redirect-to uri="login.html"/>
            </map:match>
            
            <!-- Editorial Login failure page -->
            <map:match pattern="editorial/login_failure.html">
                <map:act type="auth-loggedIn">
                    <map:parameter name="handler" value="authhandler"/>
                    <map:redirect-to uri="editorial/index.html"/>
                </map:act>
                <map:generate src="editorial/login_failure.html"/>
                <map:transform type="xslt2" src="common/xslt/template_static_pages.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="login_failure.html"/>
                </map:transform>
                <map:transform type="encodeURL"/>
                <map:serialize type="xhtml"/>
            </map:match>
            
            
            
<!--pattern to redirect to homepage when no specific page is requested-->
    <!--Need to make a way to automatically determine latest issue and redirect,
        apply to Atom feed too. [CRB]-->
            <map:match type="regexp" pattern="^$|^index\.html$">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_toc.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="index.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- redirects for older style URL requests [CRB] -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+)\.html">
                <map:redirect-to uri="{3}/{3}.html"/>
            </map:match>
            <!-- pattern to access index of specific issue article -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(\d+)\.html">
                <map:generate src="articles/{4}/{4}.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="vol/{1}/{2}/{3}{4}.html"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                    <map:parameter name="id" value="{4}"/>
                    <map:parameter name="use-request-parameters" value="true"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            
             <!-- pattern to access index of specific pdf article from a published issue. -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(\d+)\.pdf">
	            <map:read src="articles/{4}/{4}.pdf"/>
            </map:match>
          
            
       <!--atom feed link - update this with every new issue alongwith homepage link -->
            <map:match pattern="feed/news.xml">
               <map:generate src="toc/toc.xml"/>
               <map:transform type="xslt2" src="feed/atomnews.xsl"/>
                <map:serialize type="xml"/>
            </map:match>
       <!-- Use toc.xml file to generate the bios page -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/bios\.html">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_bios.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="vol/{1}/{2}/bios.html"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                </map:transform>
                <map:transform type="xslt2" src="common/xslt/bios_sort.xsl"/>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- pattern to access author bios for preview articles -->
            <map:match pattern="preview/bios.html">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_preview_bios.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="preview/bios.html"/>
                </map:transform>
                <map:transform type="xslt2" src="common/xslt/bios_sort.xsl"/>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- pattern to access preview ToC -->
            <map:match type="regexp" pattern="preview/?(index.html)?$">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_preview.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="preview/index.html"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- Title index -->
            <map:match pattern="index/title.html">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/title_index.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="index/title.html"/>
                </map:transform>
                <map:transform type="xslt2" src="common/xslt/title_sort.xsl"/>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- Author index -->
            <map:match pattern="index/author.html">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/author_index.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="index/author.html"/>
                </map:transform>
                <map:transform type="xslt2" src="common/xslt/author_sort.xsl"/>
                <map:serialize type="xhtml"/>
            </map:match>
            <!-- redirects for older style URL requests [CRB] -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+)\.xml">
                <map:redirect-to uri="{3}/{3}.xml"/>
            </map:match>
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+)\.pdf">
                <map:redirect-to uri="{3}/{3}.pdf"/>
            </map:match>
            <!-- added for display of encoded xml files -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/(\d+/)(\d+)\.xml">
                <map:read src="articles/{4}/{4}.xml" mime-type="text/xml"/>
            </map:match>

            
            <!-- pattern to access index of specific issue ToC -->
            <map:match type="regexp" pattern="vol/0*(\d+)/0*(\d+)/?(index.html)?$">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_toc.xsl">
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="fpath" value="vol/{1}/{2}/index.html"/>
                    <map:parameter name="vol" value="{1}"/>
                    <map:parameter name="issue" value="{2}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            
            <!-- for data-sharing directory -->
            
             <map:match pattern="data/*">
                 <map:read src="data/{1}"/>
             </map:match>
          
          <map:match pattern="data/*.xml">
            <map:generate src="data/{1}.xml"/>
          </map:match>
            
            
<!--resolve the difference between inside article images vs. common images like banner-->
            <!-- IMAGES (common banner images) BEGIN -->
            <map:match pattern="common/images/*.png">
                <map:read src="common/images/{1}.png" mime-type="image/png"/>
            </map:match>
            <map:match pattern="common/images/*.gif">
                <map:read src="common/images/{1}.gif" mime-type="image/gif"/>
            </map:match>
           <map:match pattern="common/images/*.jpg">
                <map:read src="common/images/{1}.jpg" mime-type="image/jpg"/>
            </map:match>
            <map:match pattern="common/images/*.ico">
                <map:read src="common/images/{1}.ico" mime-type="image/ico"/>
            </map:match>

            <!--Added for banner images -->
            <map:match pattern="common/images/bannerimg/*.jpg">
                <map:read src="common/images/bannerimg/{1}.jpg" mime-type="image/jpg"/>
            </map:match>

            <!-- RESOURCES (article specific img/audio/video/code) -->
            <!-- All resources must have a lower case file extension [CRB] -->
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.pdf">
                <map:read src="articles/{1}/resources/images/{2}.pdf"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/pdf/(.*)\.pdf">
                <map:read src="articles/{1}/resources/pdf/{2}.pdf"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/cbz/(.*)\.cbz">
                <map:read src="articles/{1}/resources/cbz/{2}.cbz"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.png">
                <map:read src="articles/{1}/resources/images/{2}.png" mime-type="image/png"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.gif">
                <map:read src="articles/{1}/resources/images/{2}.gif" mime-type="image/gif"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.jpg">
                <map:read src="articles/{1}/resources/images/{2}.jpg" mime-type="image/jpg"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.tif">
                <map:read src="articles/{1}/resources/images/{2}.tif" mime-type="image/tiff"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.mp3">
                <map:read src="articles/{1}/resources/audio/{2}.mp3" mime-type="audio/x-mp3"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.wma">
                <map:read src="articles/{1}/resources/audio/{2}.wma" mime-type="audio/x-ms-wma"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/images/(.*)\.wav">
                <map:read src="articles/{1}/resources/audio/{2}.mp3" mime-type="audio/x-wav"/>
            </map:match>
            <!-- handle code txt zip file cases-->
            <map:match type="regexp" pattern="(\d+)/resources/source/(.*)\.txt">
                <map:read src="articles/{1}/resources/source/{2}.txt" mime-type="text/plain"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/source/(.*)\.html">
                <map:read src="articles/{1}/resources/source/{2}.html" mime-type="text/html"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/css/(.*)\.css">
                <map:read src="articles/{1}/resources/css/{2}.css" mime-type="text/css"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/source/(.*)\.zip">
                <map:read src="articles/{1}/resources/source/{2}.zip" mime-type="application/zip"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/source/(.*)\.(tar\.gz|tgz)">
                <map:read src="articles/{1}/resources/source/{2}.{3}" mime-type="application/x-gtar"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/source/(.*)\.t3">
                <map:read src="articles/{1}/resources/source/{2}.t3" mime-type="x-t3vm-image"/>
            </map:match>
            <map:match type="regexp" pattern="(\d+)/resources/javascript/(.*)\.js">
                <map:read src="articles/{1}/resources/javascript/{2}.js" mime-type="text/javascript"/>
            </map:match>
            <!-- Catch all for any file under article resource subdirectory not specified above [CRB] -->
            <map:match type="regexp" pattern="(\d+)/resources/(.*)\.(.*)$">
                <map:read src="articles/{1}/resources/{2}.{3}" mime-type="application/octet-stream"/>
            </map:match>
            <!-- for peerreview form txt file -->
            <map:match pattern="submissions/*.txt">
                <map:read src="submissions/{1}.txt" mime-type="text/plain"/>
            </map:match>

            <!-- for robots.txt -->
            <map:match pattern="robots.txt">
                <map:read src="robots.txt" mime-type="text/plain"/>
            </map:match>
            
            <!-- OAI/SRU Pipelines -->
            <!-- Generate metadata index of TOC articles. -->
            <!-- NOTE: May want to make this only available with authorization. -->
            
            <map:match pattern="metadataindex.xml">
                <!--<map:generate src="toc/toc_test.xml"/>-->
                <map:generate src="toc/toc.xml"/> 
                <map:transform type="xslt2" src="common/xslt/oai_metadata_index.xsl"/>
                <map:serialize type="xml"/>
            </map:match>
            
            <!-- Return OAI records via SRU emulation. -->
            
            <map:match pattern="sru">
                <map:act type="req-params" >
                    <map:parameter name="parameters" value="query startRecord recordSchema"/>
                    <map:generate src="cocoon:/metadataindex.xml"/>
                    <map:transform type="xslt2" src="common/xslt/oai_1_get-result-set.xsl">
                        <map:parameter name="query" value="{raw-request-param:query}"/>
                    </map:transform>
                    <map:transform type="xslt2" src="common/xslt/oai_2_narrow-results.xsl">
                        <map:parameter name="startRecord" value="{raw-request-param:startRecord}"/>
                    </map:transform>
                    <map:transform type="xslt2" src="common/xslt/oai_3_return-sru.xsl">
                        <map:parameter name="recordSchema" value="{raw-request-param:recordSchema}"/>
                    </map:transform>
                    <map:serialize type="xml"/>
                </map:act>
                <map:generate src="sruExplain.xml"/>
                <map:serialize type="xml"/>
            </map:match>
            
            <!-- End OAI Pipelines -->

            <!-- catch-all for everything else -->
            <map:match type="regexp" pattern="(.+)">
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="fpath" value="{1}"/>
                    <map:parameter name="context" value="{global:context}"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:match>
            
            <map:handle-errors>
                <map:generate src="toc/toc.xml"/>
                <map:transform type="xslt2" src="common/xslt/template_article.xsl">
                    <map:parameter name="fpath" value="contact/error.html"/>
                    <map:parameter name="context" value="{global:context}"/>
                    <map:parameter name="error" value="true"/>
                </map:transform>
                <map:serialize type="xhtml"/>
            </map:handle-errors>
        
            


            
        </map:pipeline>
        
        
        
    </map:pipelines>
</map:sitemap>
